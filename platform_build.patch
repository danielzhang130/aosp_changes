From 03da96e999ed1928469a23a5aa58e6db176d6660 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Fri, 30 Sep 2022 22:46:34 -0400
Subject: [PATCH 1/5] patch

Change-Id: Ib37ca8514fbf326efe6abc016f80865a2168c5c5
---
 target/board/gsi_system_ext.prop            |  2 +-
 target/board/pixel_3/BoardConfig.mk         | 70 +++++++++++++++++
 target/board/pixel_3/README.txt             |  7 ++
 target/board/pixel_3/device.mk              | 84 +++++++++++++++++++++
 target/board/pixel_3/sepolicy/OWNERS        |  1 +
 target/board/pixel_3/sepolicy/file.te       |  6 ++
 target/board/pixel_3/sepolicy/file_contexts | 12 +++
 target/board/pixel_3/system_ext.prop        |  5 ++
 target/product/AndroidProducts.mk           |  1 +
 target/product/pixel_3.mk                   | 10 +++
 10 files changed, 197 insertions(+), 1 deletion(-)
 create mode 100644 target/board/pixel_3/BoardConfig.mk
 create mode 100644 target/board/pixel_3/README.txt
 create mode 100644 target/board/pixel_3/device.mk
 create mode 100644 target/board/pixel_3/sepolicy/OWNERS
 create mode 100644 target/board/pixel_3/sepolicy/file.te
 create mode 100644 target/board/pixel_3/sepolicy/file_contexts
 create mode 100644 target/board/pixel_3/system_ext.prop
 create mode 100644 target/product/pixel_3.mk

diff --git a/target/board/gsi_system_ext.prop b/target/board/gsi_system_ext.prop
index 780aadc..7c87e5d 100644
--- a/target/board/gsi_system_ext.prop
+++ b/target/board/gsi_system_ext.prop
@@ -2,7 +2,7 @@
 ro.cp_system_other_odex=0
 
 # GSI always disables adb authentication
-ro.adb.secure=0
+ro.adb.secure=1
 
 # GSI disables non-AOSP nnapi extensions on product partition
 ro.nnapi.extensions.deny_on_product=true
diff --git a/target/board/pixel_3/BoardConfig.mk b/target/board/pixel_3/BoardConfig.mk
new file mode 100644
index 0000000..40be80e
--- /dev/null
+++ b/target/board/pixel_3/BoardConfig.mk
@@ -0,0 +1,70 @@
+# Copyright (C) 2018 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+# arm64 emulator specific definitions
+TARGET_ARCH := arm64
+TARGET_ARCH_VARIANT := armv8-a
+TARGET_CPU_VARIANT := generic
+TARGET_CPU_ABI := arm64-v8a
+
+TARGET_2ND_ARCH := arm
+TARGET_2ND_CPU_ABI := armeabi-v7a
+TARGET_2ND_CPU_ABI2 := armeabi
+
+ifneq ($(TARGET_BUILD_APPS)$(filter cts sdk,$(MAKECMDGOALS)),)
+# DO NOT USE
+# DO NOT USE
+#
+# This architecture / CPU variant must NOT be used for any 64 bit
+# platform builds. It is the lowest common denominator required
+# to build an unbundled application or cts for all supported 32 and 64 bit
+# platforms.
+#
+# If you're building a 64 bit platform (and not an application) the
+# ARM-v8 specification allows you to assume all the features available in an
+# armv7-a-neon CPU. You should set the following as 2nd arch/cpu variant:
+#
+# TARGET_2ND_ARCH_VARIANT := armv8-a
+# TARGET_2ND_CPU_VARIANT := generic
+#
+# DO NOT USE
+# DO NOT USE
+TARGET_2ND_ARCH_VARIANT := armv7-a-neon
+# DO NOT USE
+# DO NOT USE
+TARGET_2ND_CPU_VARIANT := generic
+# DO NOT USE
+# DO NOT USE
+else
+TARGET_2ND_ARCH_VARIANT := armv8-a
+TARGET_2ND_CPU_VARIANT := generic
+endif
+
+# Include 64-bit mediaserver to support 64-bit only devices
+TARGET_DYNAMIC_64_32_MEDIASERVER := true
+
+include build/make/target/board/BoardConfigGsiCommon.mk
+
+# Some vendors still haven't cleaned up all device specific directories under
+# root!
+
+# TODO(b/111434759, b/111287060) SoC specific hacks
+BOARD_ROOT_EXTRA_SYMLINKS += /vendor/lib/dsp:/dsp
+BOARD_ROOT_EXTRA_SYMLINKS += /mnt/vendor/persist:/persist
+BOARD_ROOT_EXTRA_SYMLINKS += /vendor/firmware_mnt:/firmware
+
+# TODO(b/36764215): remove this setting when the generic system image
+# no longer has QCOM-specific directories under /.
+BOARD_SEPOLICY_DIRS += build/make/target/board/generic_arm64/sepolicy
diff --git a/target/board/pixel_3/README.txt b/target/board/pixel_3/README.txt
new file mode 100644
index 0000000..8711a14
--- /dev/null
+++ b/target/board/pixel_3/README.txt
@@ -0,0 +1,7 @@
+The "generic_arm64" product defines a non-hardware-specific arm64 target
+without a bootloader.
+
+It is also the target to build the generic kernel image (GKI).
+
+It is not a product "base class"; no other products inherit
+from it or use it in any way.
diff --git a/target/board/pixel_3/device.mk b/target/board/pixel_3/device.mk
new file mode 100644
index 0000000..b143d9b
--- /dev/null
+++ b/target/board/pixel_3/device.mk
@@ -0,0 +1,84 @@
+#
+# Copyright (C) 2013 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+include $(SRC_TARGET_DIR)/product/generic_kernel.mk
+
+ifdef BUILD_WITH_KERNEL
+
+# Keep prebuilt
+PRODUCT_COPY_FILES += \
+    kernel/prebuilts/4.19/arm64/kernel-4.19-gz:kernel-4.19-gz \
+    kernel/prebuilts/mainline/arm64/kernel-mainline-allsyms:kernel-mainline \
+    kernel/prebuilts/mainline/arm64/kernel-mainline-gz-allsyms:kernel-mainline-gz \
+    kernel/prebuilts/mainline/arm64/kernel-mainline-lz4-allsyms:kernel-mainline-lz4 \
+
+PRODUCT_COPY_FILES += \
+    kernel/prebuilts/5.4/arm64/kernel-5.4:kernel-5.4 \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-gz:kernel-5.4-gz \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-lz4:kernel-5.4-lz4 \
+    $(OUT_DIR)/target/kernel/5.10/arm64/kernel-5.10:kernel-5.10 \
+    $(OUT_DIR)/target/kernel/5.10/arm64/kernel-5.10-gz:kernel-5.10-gz \
+    $(OUT_DIR)/target/kernel/5.10/arm64/kernel-5.10-lz4:kernel-5.10-lz4 \
+
+ifneq (,$(filter userdebug eng,$(TARGET_BUILD_VARIANT)))
+PRODUCT_COPY_FILES += \
+    kernel/prebuilts/4.19/arm64/kernel-4.19-gz:kernel-4.19-gz-allsyms \
+    kernel/prebuilts/5.4/arm64/kernel-5.4:kernel-5.4-allsyms \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-gz:kernel-5.4-gz-allsyms \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-lz4:kernel-5.4-lz4-allsyms \
+    $(OUT_DIR)/target/kernel/5.10/arm64/kernel-5.10-allsyms:kernel-5.10-allsyms \
+    $(OUT_DIR)/target/kernel/5.10/arm64/kernel-5.10-gz-allsyms:kernel-5.10-gz-allsyms \
+    $(OUT_DIR)/target/kernel/5.10/arm64/kernel-5.10-lz4-allsyms:kernel-5.10-lz4-allsyms \
+
+endif
+
+else # BUILD_WITH_KERNEL
+
+PRODUCT_COPY_FILES += \
+    kernel/prebuilts/4.19/arm64/kernel-4.19-gz:kernel-4.19-gz \
+    kernel/prebuilts/5.4/arm64/kernel-5.4:kernel-5.4 \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-gz:kernel-5.4-gz \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-lz4:kernel-5.4-lz4 \
+    kernel/prebuilts/5.10/arm64/kernel-5.10:kernel-5.10 \
+    kernel/prebuilts/5.10/arm64/kernel-5.10-gz:kernel-5.10-gz \
+    kernel/prebuilts/5.10/arm64/kernel-5.10-lz4:kernel-5.10-lz4 \
+
+$(call _output-kernel-info,kernel/prebuilts/4.19/arm64,kernel/4.19)
+$(call _output-kernel-info,kernel/prebuilts/5.4/arm64,kernel/5.4)
+$(call _output-kernel-info,kernel/prebuilts/5.10/arm64,kernel/5.10)
+
+ifneq (,$(filter userdebug eng,$(TARGET_BUILD_VARIANT)))
+PRODUCT_COPY_FILES += \
+    kernel/prebuilts/4.19/arm64/kernel-4.19-gz-allsyms:kernel-4.19-gz-allsyms \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-allsyms:kernel-5.4-allsyms \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-gz-allsyms:kernel-5.4-gz-allsyms \
+    kernel/prebuilts/5.4/arm64/kernel-5.4-lz4-allsyms:kernel-5.4-lz4-allsyms \
+    kernel/prebuilts/5.10/arm64/kernel-5.10-allsyms:kernel-5.10-allsyms \
+    kernel/prebuilts/5.10/arm64/kernel-5.10-gz-allsyms:kernel-5.10-gz-allsyms \
+    kernel/prebuilts/5.10/arm64/kernel-5.10-lz4-allsyms:kernel-5.10-lz4-allsyms \
+
+$(call _output-kernel-info-debug,kernel/prebuilts/4.19/arm64,kernel/4.19-debug)
+$(call _output-kernel-info-debug,kernel/prebuilts/5.4/arm64,kernel/5.4-debug)
+$(call _output-kernel-info-debug,kernel/prebuilts/5.10/arm64,kernel/5.10-debug)
+
+endif
+
+endif # BUILD_WITH_KERNEL
+
+PRODUCT_BUILD_VENDOR_BOOT_IMAGE := false
+PRODUCT_BUILD_RECOVERY_IMAGE := false
+
+$(call inherit-product, $(SRC_TARGET_DIR)/product/generic_ramdisk.mk)
diff --git a/target/board/pixel_3/sepolicy/OWNERS b/target/board/pixel_3/sepolicy/OWNERS
new file mode 100644
index 0000000..6dc2b86
--- /dev/null
+++ b/target/board/pixel_3/sepolicy/OWNERS
@@ -0,0 +1 @@
+include platform/system/sepolicy:/OWNERS
diff --git a/target/board/pixel_3/sepolicy/file.te b/target/board/pixel_3/sepolicy/file.te
new file mode 100644
index 0000000..7adfdfa
--- /dev/null
+++ b/target/board/pixel_3/sepolicy/file.te
@@ -0,0 +1,6 @@
+# TODO(b/36764215): remove this file when the generic system image
+# no longer has these directories
+type persist_file, file_type;
+
+# Default type for anything under /firmware.
+type firmware_file, fs_type, contextmount_type;
diff --git a/target/board/pixel_3/sepolicy/file_contexts b/target/board/pixel_3/sepolicy/file_contexts
new file mode 100644
index 0000000..0a80559
--- /dev/null
+++ b/target/board/pixel_3/sepolicy/file_contexts
@@ -0,0 +1,12 @@
+# TODO(b/36764215): remove this file when the generic system image
+# no longer has these directories. They are specific to QCOM.
+
+# /
+/tombstones             u:object_r:rootfs:s0
+/dsp                    u:object_r:rootfs:s0
+
+# /persist
+/persist(/.*)?          u:object_r:persist_file:s0
+
+# files in firmware
+/firmware(/.*)?         u:object_r:firmware_file:s0
diff --git a/target/board/pixel_3/system_ext.prop b/target/board/pixel_3/system_ext.prop
new file mode 100644
index 0000000..5b0183a
--- /dev/null
+++ b/target/board/pixel_3/system_ext.prop
@@ -0,0 +1,5 @@
+#
+# system.prop for generic arm64 sdk
+#
+
+rild.libpath=/vendor/lib64/libreference-ril.so
diff --git a/target/product/AndroidProducts.mk b/target/product/AndroidProducts.mk
index ee702e5..6cd24ce 100644
--- a/target/product/AndroidProducts.mk
+++ b/target/product/AndroidProducts.mk
@@ -79,6 +79,7 @@ PRODUCT_MAKEFILES += \
     $(LOCAL_DIR)/module_arm64.mk \
     $(LOCAL_DIR)/module_x86.mk \
     $(LOCAL_DIR)/module_x86_64.mk \
+    $(LOCAL_DIR)/pixel_3.mk \
 
 COMMON_LUNCH_CHOICES := \
     aosp_arm64-eng \
diff --git a/target/product/pixel_3.mk b/target/product/pixel_3.mk
new file mode 100644
index 0000000..f6061b6
--- /dev/null
+++ b/target/product/pixel_3.mk
@@ -0,0 +1,10 @@
+$(call inherit-product, $(SRC_TARGET_DIR)/product/aosp_arm64.mk)
+$(call inherit-product, $(SRC_TARGET_DIR)/product/gsi_release.mk)
+
+PRODUCT_NAME := pixel_3
+PRODUCT_DEVICE := pixel_3
+PRODUCT_BRAND := Google
+PRODUCT_MODEL := Pixel 3
+PRODUCT_CHARACTERISTICS := phone
+PRODUCT_MANUFACTURER := My Custom
+
-- 
2.34.1


From e9b83d71e65496235a1650b0d62634ce61cfc2f2 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Fri, 18 Nov 2022 22:11:03 -0500
Subject: [PATCH 2/5] Add stock fingerprint

Change-Id: Ib825c8109e9a210efb748b8a162888b9900e7814
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 core/main.mk              | 1 +
 target/board/blueline     | 1 +
 target/product/pixel_3.mk | 8 ++++++--
 3 files changed, 8 insertions(+), 2 deletions(-)
 create mode 120000 target/board/blueline

diff --git a/core/main.mk b/core/main.mk
index c63c6df..2306e85 100644
--- a/core/main.mk
+++ b/core/main.mk
@@ -184,6 +184,7 @@ TARGET_BUILD_JAVA_SUPPORT_LEVEL :=$= platform
 
 # -----------------------------------------------------------------
 
+ADDITIONAL_SYSTEM_PROPERTIES += ro.build.stock_fingerprint=${PRODUCT_STOCK_FINGERPRINT}
 ADDITIONAL_SYSTEM_PROPERTIES += ro.treble.enabled=${PRODUCT_FULL_TREBLE}
 
 $(KATI_obsolete_var PRODUCT_FULL_TREBLE,\
diff --git a/target/board/blueline b/target/board/blueline
new file mode 120000
index 0000000..d52eb9f
--- /dev/null
+++ b/target/board/blueline
@@ -0,0 +1 @@
+pixel_3/
\ No newline at end of file
diff --git a/target/product/pixel_3.mk b/target/product/pixel_3.mk
index f6061b6..684b610 100644
--- a/target/product/pixel_3.mk
+++ b/target/product/pixel_3.mk
@@ -1,8 +1,12 @@
 $(call inherit-product, $(SRC_TARGET_DIR)/product/aosp_arm64.mk)
 $(call inherit-product, $(SRC_TARGET_DIR)/product/gsi_release.mk)
 
-PRODUCT_NAME := pixel_3
-PRODUCT_DEVICE := pixel_3
+PRODUCT_PACKAGE_OVERLAYS := build/make/target/product/pixel_3/overlay
+
+PRODUCT_STOCK_FINGERPRINT := google/blueline/blueline:12/SP1A.210812.015/7679548:user/release-keys
+
+PRODUCT_NAME := blueline
+PRODUCT_DEVICE := blueline
 PRODUCT_BRAND := Google
 PRODUCT_MODEL := Pixel 3
 PRODUCT_CHARACTERISTICS := phone
-- 
2.34.1


From c98e101cb678c0ece70fd4f145987ade22c8a272 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Fri, 18 Nov 2022 22:11:50 -0500
Subject: [PATCH 3/5] restore power button function

Change-Id: I84ab760f9dfb205c9fe9ab9dd9171709ea169a2d
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 .../overlay/frameworks/base/core/res/res/values/config.xml  | 6 ++++++
 1 file changed, 6 insertions(+)
 create mode 100644 target/product/pixel_3/overlay/frameworks/base/core/res/res/values/config.xml

diff --git a/target/product/pixel_3/overlay/frameworks/base/core/res/res/values/config.xml b/target/product/pixel_3/overlay/frameworks/base/core/res/res/values/config.xml
new file mode 100644
index 0000000..98f4743
--- /dev/null
+++ b/target/product/pixel_3/overlay/frameworks/base/core/res/res/values/config.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <integer name="config_longPressOnPowerBehavior">1</integer>
+    <integer name="config_keyChordPowerVolumeUp">0</integer>
+</resources>
+
-- 
2.34.1


From 4c8a72f5f9cfa5435d462ebb3818f9ab2834b16f Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Sat, 19 Nov 2022 11:10:05 -0500
Subject: [PATCH 4/5] Set auto brightness on by default

Change-Id: I06673b1b771b2090873922333e5ab26c51f7fc89
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 .../base/packages/SettingsProvider/res/values/defaults.xml   | 5 +++++
 1 file changed, 5 insertions(+)
 create mode 100644 target/product/pixel_3/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml

diff --git a/target/product/pixel_3/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml b/target/product/pixel_3/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
new file mode 100644
index 0000000..394c586
--- /dev/null
+++ b/target/product/pixel_3/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <bool name="def_screen_brightness_automatic_mode">true</bool>
+</resources>
+
-- 
2.34.1


From bc8f9ee2c53cf7b13666fd3da92ee60a48a9a176 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Sat, 19 Nov 2022 14:55:37 -0500
Subject: [PATCH 5/5] Add stock security patch date

Change-Id: I9b501b9bb004ffab4a6f62c2bce672b4cc2826a5
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 core/main.mk              | 1 +
 target/product/pixel_3.mk | 1 +
 2 files changed, 2 insertions(+)

diff --git a/core/main.mk b/core/main.mk
index 2306e85..48221d3 100644
--- a/core/main.mk
+++ b/core/main.mk
@@ -185,6 +185,7 @@ TARGET_BUILD_JAVA_SUPPORT_LEVEL :=$= platform
 # -----------------------------------------------------------------
 
 ADDITIONAL_SYSTEM_PROPERTIES += ro.build.stock_fingerprint=${PRODUCT_STOCK_FINGERPRINT}
+ADDITIONAL_SYSTEM_PROPERTIES += ro.build.stock_security_patch=${PRODUCT_STOCK_SECURITY_PATCH}
 ADDITIONAL_SYSTEM_PROPERTIES += ro.treble.enabled=${PRODUCT_FULL_TREBLE}
 
 $(KATI_obsolete_var PRODUCT_FULL_TREBLE,\
diff --git a/target/product/pixel_3.mk b/target/product/pixel_3.mk
index 684b610..1daa9e7 100644
--- a/target/product/pixel_3.mk
+++ b/target/product/pixel_3.mk
@@ -4,6 +4,7 @@ $(call inherit-product, $(SRC_TARGET_DIR)/product/gsi_release.mk)
 PRODUCT_PACKAGE_OVERLAYS := build/make/target/product/pixel_3/overlay
 
 PRODUCT_STOCK_FINGERPRINT := google/blueline/blueline:12/SP1A.210812.015/7679548:user/release-keys
+PRODUCT_STOCK_SECURITY_PATCH := 2021-10-05
 
 PRODUCT_NAME := blueline
 PRODUCT_DEVICE := blueline
-- 
2.34.1

