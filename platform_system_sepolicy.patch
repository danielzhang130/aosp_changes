From 45ae2a521e5931a11a46fe867203553e172fe357 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Fri, 16 Dec 2022 11:57:31 -0500
Subject: [PATCH 1/3] relax sepolicy

Change-Id: Ic3045fd9b1548fc3c82d221ca9bca05d094d9734
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 Android.mk | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/Android.mk b/Android.mk
index 63b74aa..f2f5185 100644
--- a/Android.mk
+++ b/Android.mk
@@ -68,9 +68,6 @@ HAS_PRODUCT_SEPOLICY_DIR := true
 endif
 
 ifeq ($(SELINUX_IGNORE_NEVERALLOWS),true)
-ifeq ($(TARGET_BUILD_VARIANT),user)
-$(error SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
-endif
 $(warning Be careful when using the SELINUX_IGNORE_NEVERALLOWS flag. \
           It does not work in user builds and using it will \
           not stop you from failing CTS.)
-- 
2.34.1


From 35b46924a1307332217169c8d63db35cdcd2cd79 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Wed, 8 Feb 2023 17:36:52 -0500
Subject: [PATCH 2/3] Fix sdcard sepolicy

Change-Id: I3c173b9fec21c3f8918af5d5ac07da690e86940d
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 prebuilts/api/34.0/private/bluetooth.te         | 2 ++
 prebuilts/api/34.0/private/gmscore_app.te       | 2 ++
 prebuilts/api/34.0/private/mediaprovider_app.te | 6 ++++++
 prebuilts/api/34.0/private/mls                  | 4 ++--
 prebuilts/api/34.0/private/platform_app.te      | 1 +
 prebuilts/api/34.0/private/untrusted_app.te     | 1 +
 prebuilts/api/34.0/private/untrusted_app_30.te  | 4 ++++
 prebuilts/api/34.0/private/untrusted_app_32.te  | 5 +++++
 prebuilts/api/34.0/public/file.te               | 1 +
 prebuilts/api/34.0/public/fsck_untrusted.te     | 2 ++
 prebuilts/api/34.0/public/mediaserver.te        | 2 ++
 prebuilts/api/34.0/public/vold.te               | 2 ++
 private/bluetooth.te                            | 2 ++
 private/gmscore_app.te                          | 2 ++
 private/mediaprovider_app.te                    | 6 ++++++
 private/mls                                     | 4 ++--
 private/platform_app.te                         | 1 +
 private/untrusted_app.te                        | 1 +
 private/untrusted_app_30.te                     | 4 ++++
 private/untrusted_app_32.te                     | 5 +++++
 public/file.te                                  | 1 +
 public/fsck_untrusted.te                        | 2 ++
 public/mediaserver.te                           | 2 ++
 public/vold.te                                  | 2 ++
 24 files changed, 60 insertions(+), 4 deletions(-)

diff --git a/prebuilts/api/34.0/private/bluetooth.te b/prebuilts/api/34.0/private/bluetooth.te
index 0b001e2..bda33e6 100644
--- a/prebuilts/api/34.0/private/bluetooth.te
+++ b/prebuilts/api/34.0/private/bluetooth.te
@@ -86,6 +86,8 @@ hal_client_domain(bluetooth, hal_audio)
 
 read_runtime_log_tags(bluetooth)
 
+allow bluetooth unlabeled:file { getattr read };
+
 ###
 ### Neverallow rules
 ###
diff --git a/prebuilts/api/34.0/private/gmscore_app.te b/prebuilts/api/34.0/private/gmscore_app.te
index b662f4f..9ba3cfc 100644
--- a/prebuilts/api/34.0/private/gmscore_app.te
+++ b/prebuilts/api/34.0/private/gmscore_app.te
@@ -143,6 +143,8 @@ allow gmscore_app anr_data_file:file r_file_perms;
 # b/148974132: com.android.vending needs this
 allow gmscore_app priv_app:tcp_socket { read write };
 
+allow gmscore_app unlabeled:file { open read getattr };
+
 # b/168059475 Allow GMSCore to read Virtual AB properties to determine
 # if device supports VAB.
 get_prop(gmscore_app, virtual_ab_prop)
diff --git a/prebuilts/api/34.0/private/mediaprovider_app.te b/prebuilts/api/34.0/private/mediaprovider_app.te
index 7ad8feb..6d0c00b 100644
--- a/prebuilts/api/34.0/private/mediaprovider_app.te
+++ b/prebuilts/api/34.0/private/mediaprovider_app.te
@@ -73,3 +73,9 @@ dontaudit mediaprovider_app sysfs_vendor_sched:file w_file_perms;
 # bpfprog access for FUSE BPF
 allow mediaprovider_app fs_bpf:file read;
 allow mediaprovider_app bpfloader:bpf { map_read map_write prog_run };
+
+allow mediaprovider_app unlabeled:file { open create read getattr execute write setattr append unlink link rename };
+allow mediaprovider_app unlabeled:file create;
+allow mediaprovider_app unlabeled:dir { open create read getattr search write setattr rename add_name remove_name reparent rmdir };
+allow mediaprovider_app unlabeled:dir create;
+allow mediaprovider_app unlabeled:filesystem { getattr mount unmount };
diff --git a/prebuilts/api/34.0/private/mls b/prebuilts/api/34.0/private/mls
index 955c27b..9a7e3f5 100644
--- a/prebuilts/api/34.0/private/mls
+++ b/prebuilts/api/34.0/private/mls
@@ -90,10 +90,10 @@ mlsconstrain { file lnk_file sock_file chr_file blk_file } { read getattr execut
 # Write operations: Subject must be equivalent to the object unless the
 # subject or the object is trusted.
 mlsconstrain dir { write setattr rename add_name remove_name reparent rmdir }
-	     (t2 == app_data_file_type or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
+	     (t2 == unlabeled or t2 == app_data_file_type or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
 
 mlsconstrain { file lnk_file sock_file chr_file blk_file } { write setattr append unlink link rename }
-	     (t2 == app_data_file_type or t2 == appdomain_tmpfs or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
+	     (t2 == unlabeled or t2 == app_data_file_type or t2 == appdomain_tmpfs or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
 
 # Special case for FIFOs.
 # These can be unnamed pipes, in which case they will be labeled with the
diff --git a/prebuilts/api/34.0/private/platform_app.te b/prebuilts/api/34.0/private/platform_app.te
index 6d49502..4da8215 100644
--- a/prebuilts/api/34.0/private/platform_app.te
+++ b/prebuilts/api/34.0/private/platform_app.te
@@ -130,3 +130,4 @@ neverallow { domain -init userdebug_or_eng(`-shell -platform_app') } persist_sys
 
 # app domains which access /dev/fuse should not run as platform_app
 neverallow platform_app fuse_device:chr_file *;
+allow platform_app unlabeled:file getattr;
diff --git a/prebuilts/api/34.0/private/untrusted_app.te b/prebuilts/api/34.0/private/untrusted_app.te
index d0f9b24..88ff081 100644
--- a/prebuilts/api/34.0/private/untrusted_app.te
+++ b/prebuilts/api/34.0/private/untrusted_app.te
@@ -19,5 +19,6 @@ bluetooth_domain(untrusted_app)
 # TODO(b/229249719): Will not be supported in Android U
 allow untrusted_app sdk_sandbox_data_file:fd use;
 allow untrusted_app sdk_sandbox_data_file:file write;
+allow untrusted_app unlabeled:file { read write getattr };
 
 neverallow untrusted_app sdk_sandbox_data_file:file { open create };
diff --git a/prebuilts/api/34.0/private/untrusted_app_30.te b/prebuilts/api/34.0/private/untrusted_app_30.te
index c87548e..dc70dcd 100644
--- a/prebuilts/api/34.0/private/untrusted_app_30.te
+++ b/prebuilts/api/34.0/private/untrusted_app_30.te
@@ -28,6 +28,10 @@ userdebug_or_eng(`
   auditallow untrusted_app_30 mdnsd:unix_stream_socket connectto;
 ')
 
+allow untrusted_app_30 unlabeled:file {getattr read};
+allow untrusted_app_30 unlabeled:dir getattr;
+allow untrusted_app_30 unlabeled:filesystem getattr;
+
 # Allow calling inotify on APKs for backwards compatibility. This is disallowed
 # for targetSdkVersion>=34 to remove a sidechannel.
 allow untrusted_app_30 apk_data_file:dir { watch watch_reads };
diff --git a/prebuilts/api/34.0/private/untrusted_app_32.te b/prebuilts/api/34.0/private/untrusted_app_32.te
index 6e95fd1..5edef5a 100644
--- a/prebuilts/api/34.0/private/untrusted_app_32.te
+++ b/prebuilts/api/34.0/private/untrusted_app_32.te
@@ -37,3 +37,8 @@ userdebug_or_eng(`
   auditallow untrusted_app_32 apk_data_file:dir { watch watch_reads };
   auditallow untrusted_app_32 apk_data_file:file { watch watch_reads };
 ')
+
+allow untrusted_app_32 unlabeled:file {getattr read};
+allow untrusted_app_32 unlabeled:dir getattr;
+allow untrusted_app_32 unlabeled:filesystem getattr;
+
diff --git a/prebuilts/api/34.0/public/file.te b/prebuilts/api/34.0/public/file.te
index 7cfd8ad..7bdd5a2 100644
--- a/prebuilts/api/34.0/public/file.te
+++ b/prebuilts/api/34.0/public/file.te
@@ -633,3 +633,4 @@ type audiohal_data_file, file_type, data_file_type, core_data_file_type;
 # Should be:
 #   type apk_data_file, file_type, data_file_type;
 neverallow fs_type file_type:filesystem associate;
+allow unlabeled self:filesystem associate;
diff --git a/prebuilts/api/34.0/public/fsck_untrusted.te b/prebuilts/api/34.0/public/fsck_untrusted.te
index 7e981bf..c34e364 100644
--- a/prebuilts/api/34.0/public/fsck_untrusted.te
+++ b/prebuilts/api/34.0/public/fsck_untrusted.te
@@ -25,6 +25,8 @@ allow fsck_untrusted proc_mounts:file r_file_perms;
 # major/minor values.
 allow fsck_untrusted dev_type:blk_file getattr;
 
+allow fsck_untrusted sysfs:file read;
+
 ###
 ### neverallow rules
 ###
diff --git a/prebuilts/api/34.0/public/mediaserver.te b/prebuilts/api/34.0/public/mediaserver.te
index 367012c..e4a5924 100644
--- a/prebuilts/api/34.0/public/mediaserver.te
+++ b/prebuilts/api/34.0/public/mediaserver.te
@@ -143,6 +143,8 @@ allow mediaserver vendor_overlay_file:file { read getattr map };
 
 hal_client_domain(mediaserver, hal_allocator)
 
+allow mediaserver unlabeled:file { read getattr };
+
 ###
 ### neverallow rules
 ###
diff --git a/prebuilts/api/34.0/public/vold.te b/prebuilts/api/34.0/public/vold.te
index 3d204e1..7008289 100644
--- a/prebuilts/api/34.0/public/vold.te
+++ b/prebuilts/api/34.0/public/vold.te
@@ -348,3 +348,5 @@ neverallow vold fsck_exec:file execute_no_trans;
 neverallow { domain -init } vold:process { transition dyntransition };
 neverallow vold *:process ptrace;
 neverallow vold *:rawip_socket *;
+allow vold unlabeled:dir { getattr write };
+allow vold unlabeled:filesystem { getattr mount unmount };
diff --git a/private/bluetooth.te b/private/bluetooth.te
index 0b001e2..bda33e6 100644
--- a/private/bluetooth.te
+++ b/private/bluetooth.te
@@ -86,6 +86,8 @@ hal_client_domain(bluetooth, hal_audio)
 
 read_runtime_log_tags(bluetooth)
 
+allow bluetooth unlabeled:file { getattr read };
+
 ###
 ### Neverallow rules
 ###
diff --git a/private/gmscore_app.te b/private/gmscore_app.te
index 859c2ec..69b5dbe 100644
--- a/private/gmscore_app.te
+++ b/private/gmscore_app.te
@@ -142,6 +142,8 @@ allow gmscore_app anr_data_file:file r_file_perms;
 # b/148974132: com.android.vending needs this
 allow gmscore_app priv_app:tcp_socket { read write };
 
+allow gmscore_app unlabeled:file { open read getattr };
+
 # b/168059475 Allow GMSCore to read Virtual AB properties to determine
 # if device supports VAB.
 get_prop(gmscore_app, virtual_ab_prop)
diff --git a/private/mediaprovider_app.te b/private/mediaprovider_app.te
index 7ad8feb..6d0c00b 100644
--- a/private/mediaprovider_app.te
+++ b/private/mediaprovider_app.te
@@ -73,3 +73,9 @@ dontaudit mediaprovider_app sysfs_vendor_sched:file w_file_perms;
 # bpfprog access for FUSE BPF
 allow mediaprovider_app fs_bpf:file read;
 allow mediaprovider_app bpfloader:bpf { map_read map_write prog_run };
+
+allow mediaprovider_app unlabeled:file { open create read getattr execute write setattr append unlink link rename };
+allow mediaprovider_app unlabeled:file create;
+allow mediaprovider_app unlabeled:dir { open create read getattr search write setattr rename add_name remove_name reparent rmdir };
+allow mediaprovider_app unlabeled:dir create;
+allow mediaprovider_app unlabeled:filesystem { getattr mount unmount };
diff --git a/private/mls b/private/mls
index 955c27b..9a7e3f5 100644
--- a/private/mls
+++ b/private/mls
@@ -90,10 +90,10 @@ mlsconstrain { file lnk_file sock_file chr_file blk_file } { read getattr execut
 # Write operations: Subject must be equivalent to the object unless the
 # subject or the object is trusted.
 mlsconstrain dir { write setattr rename add_name remove_name reparent rmdir }
-	     (t2 == app_data_file_type or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
+	     (t2 == unlabeled or t2 == app_data_file_type or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
 
 mlsconstrain { file lnk_file sock_file chr_file blk_file } { write setattr append unlink link rename }
-	     (t2 == app_data_file_type or t2 == appdomain_tmpfs or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
+	     (t2 == unlabeled or t2 == app_data_file_type or t2 == appdomain_tmpfs or l1 eq l2 or t1 == mlstrustedsubject or t2 == mlstrustedobject);
 
 # Special case for FIFOs.
 # These can be unnamed pipes, in which case they will be labeled with the
diff --git a/private/platform_app.te b/private/platform_app.te
index cd95353..a4b816d 100644
--- a/private/platform_app.te
+++ b/private/platform_app.te
@@ -136,3 +136,4 @@ neverallow { domain -init userdebug_or_eng(`-shell -platform_app') } persist_sys
 
 # app domains which access /dev/fuse should not run as platform_app
 neverallow platform_app fuse_device:chr_file *;
+allow platform_app unlabeled:file getattr;
diff --git a/private/untrusted_app.te b/private/untrusted_app.te
index d0f9b24..88ff081 100644
--- a/private/untrusted_app.te
+++ b/private/untrusted_app.te
@@ -19,5 +19,6 @@ bluetooth_domain(untrusted_app)
 # TODO(b/229249719): Will not be supported in Android U
 allow untrusted_app sdk_sandbox_data_file:fd use;
 allow untrusted_app sdk_sandbox_data_file:file write;
+allow untrusted_app unlabeled:file { read write getattr };
 
 neverallow untrusted_app sdk_sandbox_data_file:file { open create };
diff --git a/private/untrusted_app_30.te b/private/untrusted_app_30.te
index c87548e..dc70dcd 100644
--- a/private/untrusted_app_30.te
+++ b/private/untrusted_app_30.te
@@ -28,6 +28,10 @@ userdebug_or_eng(`
   auditallow untrusted_app_30 mdnsd:unix_stream_socket connectto;
 ')
 
+allow untrusted_app_30 unlabeled:file {getattr read};
+allow untrusted_app_30 unlabeled:dir getattr;
+allow untrusted_app_30 unlabeled:filesystem getattr;
+
 # Allow calling inotify on APKs for backwards compatibility. This is disallowed
 # for targetSdkVersion>=34 to remove a sidechannel.
 allow untrusted_app_30 apk_data_file:dir { watch watch_reads };
diff --git a/private/untrusted_app_32.te b/private/untrusted_app_32.te
index 6e95fd1..5edef5a 100644
--- a/private/untrusted_app_32.te
+++ b/private/untrusted_app_32.te
@@ -37,3 +37,8 @@ userdebug_or_eng(`
   auditallow untrusted_app_32 apk_data_file:dir { watch watch_reads };
   auditallow untrusted_app_32 apk_data_file:file { watch watch_reads };
 ')
+
+allow untrusted_app_32 unlabeled:file {getattr read};
+allow untrusted_app_32 unlabeled:dir getattr;
+allow untrusted_app_32 unlabeled:filesystem getattr;
+
diff --git a/public/file.te b/public/file.te
index 01143f7..bd17f3b 100644
--- a/public/file.te
+++ b/public/file.te
@@ -643,3 +643,4 @@ type audiohal_data_file, file_type, data_file_type, core_data_file_type;
 # Should be:
 #   type apk_data_file, file_type, data_file_type;
 neverallow fs_type file_type:filesystem associate;
+allow unlabeled self:filesystem associate;
diff --git a/public/fsck_untrusted.te b/public/fsck_untrusted.te
index 7e981bf..c34e364 100644
--- a/public/fsck_untrusted.te
+++ b/public/fsck_untrusted.te
@@ -25,6 +25,8 @@ allow fsck_untrusted proc_mounts:file r_file_perms;
 # major/minor values.
 allow fsck_untrusted dev_type:blk_file getattr;
 
+allow fsck_untrusted sysfs:file read;
+
 ###
 ### neverallow rules
 ###
diff --git a/public/mediaserver.te b/public/mediaserver.te
index 367012c..e4a5924 100644
--- a/public/mediaserver.te
+++ b/public/mediaserver.te
@@ -143,6 +143,8 @@ allow mediaserver vendor_overlay_file:file { read getattr map };
 
 hal_client_domain(mediaserver, hal_allocator)
 
+allow mediaserver unlabeled:file { read getattr };
+
 ###
 ### neverallow rules
 ###
diff --git a/public/vold.te b/public/vold.te
index c0fdf50..e545320 100644
--- a/public/vold.te
+++ b/public/vold.te
@@ -351,3 +351,5 @@ neverallow vold fsck_exec:file execute_no_trans;
 neverallow { domain -init } vold:process { transition dyntransition };
 neverallow vold *:process ptrace;
 neverallow vold *:rawip_socket *;
+allow vold unlabeled:dir { getattr write };
+allow vold unlabeled:filesystem { getattr mount unmount };
-- 
2.34.1


From f7608735471a4ed3dd6ef5d71f32e017c3138d82 Mon Sep 17 00:00:00 2001
From: Daniel Zhang <danielzhang130@gmail.com>
Date: Mon, 12 Feb 2024 16:14:29 -0500
Subject: [PATCH 3/3] Update run-as sepolicy

Change-Id: I7a8334a0fcdea8574e2caf52c8b415f7582babd6
Signed-off-by: Daniel Zhang <danielzhang130@gmail.com>
---
 prebuilts/api/34.0/public/runas.te | 3 +++
 public/runas.te                    | 3 +++
 2 files changed, 6 insertions(+)

diff --git a/prebuilts/api/34.0/public/runas.te b/prebuilts/api/34.0/public/runas.te
index 356a019..66dcf4a 100644
--- a/prebuilts/api/34.0/public/runas.te
+++ b/prebuilts/api/34.0/public/runas.te
@@ -34,6 +34,9 @@ allow runas non_system_app_set:process dyntransition; # setcon
 # determine which domain to transition to.
 allow runas seapp_contexts_file:file r_file_perms;
 
+allow runas system_app_data_file:dir getattr;
+allow runas privapp_data_file:dir getattr;
+
 ###
 ### neverallow rules
 ###
diff --git a/public/runas.te b/public/runas.te
index 356a019..66dcf4a 100644
--- a/public/runas.te
+++ b/public/runas.te
@@ -34,6 +34,9 @@ allow runas non_system_app_set:process dyntransition; # setcon
 # determine which domain to transition to.
 allow runas seapp_contexts_file:file r_file_perms;
 
+allow runas system_app_data_file:dir getattr;
+allow runas privapp_data_file:dir getattr;
+
 ###
 ### neverallow rules
 ###
-- 
2.34.1

